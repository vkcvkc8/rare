<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Prospeo Email Finder</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      padding: 40px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      color: #2d3748;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header p {
      color: #718096;
      font-size: 1.1rem;
    }

    .verification-badge {
      display: inline-block;
      background: linear-gradient(135deg, #48bb78, #38a169);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 10px;
    }

    .form-section {
      display: grid;
      gap: 20px;
      margin-bottom: 30px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-group label {
      font-weight: 600;
      color: #4a5568;
      font-size: 0.9rem;
    }

    input[type="text"], input[type="file"] {
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.2s;
      background: #f7fafc;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #cbd5e0;
    }

    .btn-success {
      background: linear-gradient(135deg, #48bb78, #38a169);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }

    .stat-card {
      background: #f7fafc;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .stat-card h4 {
      color: #2d3748;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .stat-card .value {
      color: #667eea;
      font-size: 1.5rem;
      font-weight: 700;
    }

    .log-section {
      margin-top: 30px;
    }

    .log-section h3 {
      color: #2d3748;
      margin-bottom: 12px;
      font-size: 1.2rem;
    }

    #log {
      height: 400px;
      overflow-y: auto;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      background: #f7fafc;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.4;
    }

    .verification-section {
      margin-top: 20px;
      padding: 20px;
      background: #f0fff4;
      border-radius: 8px;
      border-left: 4px solid #48bb78;
    }

    .verification-section h4 {
      color: #2d3748;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #verificationData {
      color: #4a5568;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      background: white;
      padding: 12px;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      color: #e53e3e;
    }

    .success {
      color: #38a169;
    }

    .info {
      color: #3182ce;
    }

    .warning {
      color: #d69e2e;
    }

    .api-trace {
      background: #edf2f7;
      padding: 8px;
      margin: 4px 0;
      border-radius: 4px;
      border-left: 3px solid #667eea;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      button {
        width: 100%;
        justify-content: center;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîç Dynamic Prospeo Email Finder</h1>
      <p>Find professional email addresses with live API verification</p>
      <div class="verification-badge">‚úÖ 100% Dynamic API Processing</div>
    </div>

    <div class="form-section">
      <div class="input-group">
        <label for="apiKeyInput">Prospeo API Key</label>
        <input type="text" id="apiKeyInput" placeholder="Enter your Prospeo API key..." value="">
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="testApiKey()" id="testBtn">
          <span id="testBtnText">üß™ Verify API Connection</span>
        </button>
        <button class="btn-success" onclick="showVerificationReport()" id="verifyBtn">
          <span>üìä View API Call Report</span>
        </button>
      </div>

      <div class="input-group">
        <label for="fileInput">Upload CSV File</label>
        <input type="file" id="fileInput" accept=".csv">
        <small style="color: #718096;">CSV should contain: first_name, last_name, company (or variations)</small>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="processCSV()" id="processBtn">
          <span id="processBtnText">üöÄ Process All Entries Dynamically</span>
        </button>
        <button class="btn-secondary" onclick="clearLogs()">üßπ Clear Logs</button>
      </div>
    </div>

    <div class="stats-grid" id="statsGrid" style="display: none;">
      <div class="stat-card">
        <h4>Total API Calls</h4>
        <div class="value" id="totalCalls">0</div>
      </div>
      <div class="stat-card">
        <h4>Successful Finds</h4>
        <div class="value" id="successfulFinds">0</div>
      </div>
      <div class="stat-card">
        <h4>Processing Rate</h4>
        <div class="value" id="processingRate">0/min</div>
      </div>
      <div class="stat-card">
        <h4>Average Response Time</h4>
        <div class="value" id="avgResponseTime">0ms</div>
      </div>
    </div>

    <div class="log-section">
      <h3>üìä Dynamic Processing Logs & API Verification</h3>
      <div id="log">üéØ Dynamic Email Finder Ready!<br>üìã Every email will be fetched via live API calls<br>üîç No static or hardcoded data used<br>üìä Full traceability from CSV ‚Üí API ‚Üí Results<br><br>Ready to process your CSV dynamically! üöÄ</div>
    </div>

    <div class="verification-section" id="verificationSection" style="display: none;">
      <h4>üî¨ API Call Verification Data</h4>
      <div id="verificationData">No verification data available yet</div>
    </div>
  </div>

  <script>
    let isProcessing = false;
    let processedCount = 0;
    let successfulFinds = 0;
    let startTime = null;
    let apiCallTracker = [];

    // Enhanced fetch function with comprehensive logging
    async function fetchEmail(firstName, lastName, company, apiKey, rowIndex) {
      if (!apiKey) {
        logMessage("‚ùå Error: API key is missing", "error");
        return null;
      }
      if (!company) {
        logMessage("‚ùå Error: Company field is required", "error");
        return null;
      }

      const requestId = `csv_row_${rowIndex}_${Date.now()}`;
      const url = '/api/email-finder';
      const requestData = {
        first_name: firstName || '',
        last_name: lastName || '',
        company: company,
        api_key: apiKey,
        request_id: requestId
      };

      // Log the exact request being made
      logMessage(`üîç [${requestId}] API REQUEST: ${firstName || 'N/A'} ${lastName || 'N/A'} @ ${company}`, "info");
      logMessage(`üì§ [${requestId}] Payload: ${JSON.stringify(requestData, null, 2)}`, "api-trace");

      try {
        const startTime = Date.now();
        
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });

        const responseTime = Date.now() - startTime;

        if (!response.ok) {
          const errorData = await response.json();
          logMessage(`‚ùå [${requestId}] HTTP Error ${response.status}: ${errorData.error}`, "error");
          return null;
        }

        const result = await response.text();
        const parsedResult = JSON.parse(result);
        
        // Log the complete API response
        logMessage(`üì• [${requestId}] API RESPONSE (${responseTime}ms): ${result}`, "api-trace");
        
        // Track this API call for verification
        apiCallTracker.push({
          requestId,
          rowIndex,
          input: { firstName, lastName, company },
          response: parsedResult,
          responseTime,
          timestamp: new Date().toISOString()
        });

        if (parsedResult.response?.email) {
          logMessage(`‚úÖ [${requestId}] EMAIL FOUND: ${parsedResult.response.email} (Status: ${parsedResult.response.email_status})`, "success");
          successfulFinds++;
        } else {
          const status = parsedResult.response?.email_status || 'NO_RESULT';
          logMessage(`‚ùå [${requestId}] NO EMAIL: Status = ${status}`, "warning");
        }

        updateStats();
        return result;
      } catch (error) {
        logMessage(`‚ùå [${requestId}] FETCH ERROR: ${error.message}`, "error");
        return null;
      }
    }

    function logMessage(message, type = "info") {
      const log = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === "error" ? "error" : 
                       type === "success" ? "success" : 
                       type === "warning" ? "warning" :
                       type === "api-trace" ? "api-trace" : "info";
      
      log.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      log.scrollTop = log.scrollHeight;
    }

    function updateStats() {
      document.getElementById('totalCalls').textContent = processedCount;
      document.getElementById('successfulFinds').textContent = successfulFinds;
      
      if (startTime) {
        const elapsed = (Date.now() - startTime) / 1000 / 60; // minutes
        const rate = elapsed > 0 ? Math.round(processedCount / elapsed) : 0;
        document.getElementById('processingRate').textContent = `${rate}/min`;
      }
      
      if (apiCallTracker.length > 0) {
        const avgTime = Math.round(
          apiCallTracker.reduce((sum, call) => sum + call.responseTime, 0) / apiCallTracker.length
        );
        document.getElementById('avgResponseTime').textContent = `${avgTime}ms`;
      }
    }

    async function testApiKey() {
      if (isProcessing) return;
      
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      if (!apiKey) {
        logMessage("‚ùå Please enter your API key first", "error");
        return;
      }

      setButtonLoading('testBtn', 'testBtnText', true, 'Testing API...');
      logMessage("üß™ TESTING API KEY with dynamic test data...", "info");
      
      // Use dynamic test data - no hardcoded emails
      const testData = {
        firstName: 'Test',
        lastName: 'User',
        company: 'example.com'
      };
      
      logMessage(`üéØ Test parameters: ${JSON.stringify(testData)}`, "info");
      
      const response = await fetchEmail(testData.firstName, testData.lastName, testData.company, apiKey, 'test');
      if (response) {
        logMessage("üéâ API CONNECTION VERIFIED! Key is working with live API.", "success");
        try {
          const jsonResponse = JSON.parse(response);
          logMessage(`üìä Test response status: ${jsonResponse.response?.email_status || 'UNKNOWN'}`, "info");
        } catch (e) {
          logMessage("‚ö†Ô∏è Response received but parsing failed", "warning");
        }
      } else {
        logMessage("‚ùå API test failed. Please verify your API key.", "error");
      }
      
      setButtonLoading('testBtn', 'testBtnText', false, 'üß™ Verify API Connection');
    }

    async function processCSV() {
      if (isProcessing) return;
      
      const fileInput = document.getElementById('fileInput');
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      
      if (!apiKey) {
        logMessage("‚ùå Please enter your API key first", "error");
        return;
      }
      
      if (!fileInput.files.length) {
        logMessage("‚ùå Please upload a CSV file", "error");
        return;
      }

      isProcessing = true;
      processedCount = 0;
      successfulFinds = 0;
      startTime = Date.now();
      apiCallTracker = [];
      
      setButtonLoading('processBtn', 'processBtnText', true, 'Processing Dynamically...');
      document.getElementById('statsGrid').style.display = 'grid';
      
      const file = fileInput.files[0];
      logMessage(`üìÅ STARTING DYNAMIC PROCESSING: ${file.name}`, "info");
      logMessage(`üéØ VERIFICATION MODE: Every result will come from live API calls`, "info");
      
      Papa.parse(file, {
        header: true,
        complete: async function(results) {
          const allRows = results.data.filter(row => {
            // Filter out completely empty rows
            return Object.values(row).some(value => value && value.toString().trim());
          });
          
          logMessage(`üìä CSV PARSED: ${allRows.length} total rows found`, "info");
          logMessage(`üîÑ PROCESSING MODE: Dynamic API calls for ALL entries`, "info");
          logMessage(`‚è±Ô∏è Estimated time: ${Math.ceil(allRows.length * 1.2 / 60)} minutes (with rate limiting)`, "info");
          
          // Detect column mappings dynamically
          const headers = Object.keys(allRows[0] || {});
          const columnMapping = detectColumnMapping(headers);
          logMessage(`üóÇÔ∏è COLUMN MAPPING: ${JSON.stringify(columnMapping)}`, "info");
          
          const enrichedData = [];
          
          for (let i = 0; i < allRows.length; i++) {
            const row = allRows[i];
            processedCount++;
            
            // Extract data dynamically based on detected columns
            const firstName = extractValue(row, columnMapping.firstName);
            const lastName = extractValue(row, columnMapping.lastName);
            const company = extractValue(row, columnMapping.company);
            
            if (!company) {
              logMessage(`‚ö†Ô∏è [Row ${i+1}] Skipping: No company data found`, "warning");
              enrichedData.push({ ...row, email: '', email_status: 'NO_COMPANY_DATA' });
              continue;
            }
            
            logMessage(`üîÑ [${processedCount}/${allRows.length}] DYNAMIC PROCESSING: Row ${i+1}`, "info");
            logMessage(`üìã Input: "${firstName || 'N/A'}" "${lastName || 'N/A'}" @ "${company}"`, "info");
            
            const response = await fetchEmail(firstName, lastName, company, apiKey, i+1);
            let enrichedRow = { ...row, email: '', email_status: 'API_ERROR' };
            
            if (response) {
              try {
                const jsonResponse = JSON.parse(response);
                const email = jsonResponse.response?.email || '';
                const status = jsonResponse.response?.email_status || 'NO_RESULT';
                
                enrichedRow = {
                  ...row,
                  email: email,
                  email_status: status
                };
                
                logMessage(`üìä [Row ${i+1}] RESULT: Email="${email}" Status="${status}"`, email ? "success" : "warning");
                
                // Verify this came from API
                if (jsonResponse._meta) {
                  logMessage(`‚úÖ [Row ${i+1}] VERIFIED: API Request #${jsonResponse._meta.requestNumber} (${jsonResponse._meta.responseTime}ms)`, "success");
                }
                
              } catch (e) {
                logMessage(`‚ùå [Row ${i+1}] Error parsing API response: ${e.message}`, "error");
              }
            } else {
              logMessage(`‚ùå [Row ${i+1}] API call failed - no response received`, "error");
            }
            
            enrichedData.push(enrichedRow);
            updateStats();
            
            // Rate limiting - 200ms between requests (5 requests/second max)
            if (processedCount < allRows.length) {
              logMessage(`‚è≥ Rate limiting: Waiting 200ms before next API call...`, "info");
              await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // Daily limit compliance - pause every 150 requests
            if (processedCount % 150 === 0 && processedCount < allRows.length) {
              logMessage(`‚è∏Ô∏è Daily limit compliance: 60-second pause after ${processedCount} requests`, "warning");
              await new Promise(resolve => setTimeout(resolve, 60000));
            }
          }
          
          if (enrichedData.length > 0) {
            downloadCSV(enrichedData);
            logMessage(`üéâ DYNAMIC PROCESSING COMPLETE!`, "success");
            logMessage(`üìä FINAL STATS: ${enrichedData.length} rows processed, ${successfulFinds} emails found`, "success");
            logMessage(`‚úÖ VERIFICATION: All ${apiCallTracker.length} results came from live API calls`, "success");
          } else {
            logMessage("‚ùå No data to download", "error");
          }
          
          isProcessing = false;
          setButtonLoading('processBtn', 'processBtnText', false, 'üöÄ Process All Entries Dynamically');
          
          // Show verification section
          document.getElementById('verificationSection').style.display = 'block';
          updateVerificationDisplay();
        },
        error: function(error) {
          logMessage(`‚ùå CSV parsing error: ${error.message}`, "error");
          isProcessing = false;
          setButtonLoading('processBtn', 'processBtnText', false, 'üöÄ Process All Entries Dynamically');
        }
      });
    }

    function detectColumnMapping(headers) {
      const mapping = {
        firstName: null,
        lastName: null,
        company: null
      };
      
      // Detect first name column
      const firstNameCandidates = ['first_name', 'firstname', 'first', 'fname', 'given_name'];
      mapping.firstName = headers.find(h => 
        firstNameCandidates.some(candidate => 
          h.toLowerCase().includes(candidate.toLowerCase())
        )
      );
      
      // Detect last name column
      const lastNameCandidates = ['last_name', 'lastname', 'last', 'lname', 'surname', 'family_name'];
      mapping.lastName = headers.find(h => 
        lastNameCandidates.some(candidate => 
          h.toLowerCase().includes(candidate.toLowerCase())
        )
      );
      
      // Detect company column
      const companyCandidates = ['company', 'domain', 'website', 'organization', 'org', 'employer'];
      mapping.company = headers.find(h => 
        companyCandidates.some(candidate => 
          h.toLowerCase().includes(candidate.toLowerCase())
        )
      );
      
      return mapping;
    }

    function extractValue(row, columnName) {
      if (!columnName) return '';
      return (row[columnName] || '').toString().trim();
    }

    function downloadCSV(data) {
      try {
        const csv = Papa.unparse(data);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `dynamic_emails_${new Date().toISOString().split('T')[0]}_${Date.now()}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        logMessage("üì• Dynamic results CSV downloaded successfully!", "success");
        logMessage(`‚úÖ File contains ${data.length} rows with live API results`, "success");
      } catch (error) {
        logMessage(`‚ùå Download error: ${error.message}`, "error");
      }
    }

    async function showVerificationReport() {
      try {
        const response = await fetch('/api/verification-report');
        const report = await response.json();
        
        logMessage("üìä FETCHING VERIFICATION REPORT FROM SERVER...", "info");
        logMessage(`üîç Server Report: ${report.totalApiCalls} total calls, ${report.successfulCalls} successful`, "success");
        
        document.getElementById('verificationSection').style.display = 'block';
        updateVerificationDisplay(report);
      } catch (error) {
        logMessage(`‚ùå Error fetching verification report: ${error.message}`, "error");
      }
    }

    function updateVerificationDisplay(serverReport = null) {
      const verificationEl = document.getElementById('verificationData');
      
      let content = `CLIENT-SIDE VERIFICATION:\n`;
      content += `‚Ä¢ Total API calls tracked: ${apiCallTracker.length}\n`;
      content += `‚Ä¢ Successful email finds: ${successfulFinds}\n`;
      content += `‚Ä¢ All results from live API: ${apiCallTracker.length > 0 ? 'YES' : 'NO CALLS YET'}\n\n`;
      
      if (serverReport) {
        content += `SERVER-SIDE VERIFICATION:\n`;
        content += `‚Ä¢ Total API calls: ${serverReport.totalApiCalls}\n`;
        content += `‚Ä¢ Successful calls: ${serverReport.successfulCalls}\n`;
        content += `‚Ä¢ Failed calls: ${serverReport.failedCalls}\n`;
        content += `‚Ä¢ Average response time: ${serverReport.averageResponseTime}ms\n\n`;
      }
      
      if (apiCallTracker.length > 0) {
        content += `RECENT API CALL SAMPLES:\n`;
        const recentCalls = apiCallTracker.slice(-5);
        recentCalls.forEach((call, index) => {
          content += `${index + 1}. [${call.requestId}] ${call.input.firstName} ${call.input.lastName} @ ${call.input.company}\n`;
          content += `   ‚Üí Email: ${call.response.response?.email || 'None'}\n`;
          content += `   ‚Üí Status: ${call.response.response?.email_status || 'Unknown'}\n`;
          content += `   ‚Üí Response Time: ${call.responseTime}ms\n\n`;
        });
      }
      
      verificationEl.textContent = content;
    }

    function clearLogs() {
      document.getElementById('log').innerHTML = 'üßπ Logs cleared. Ready for new dynamic processing! üöÄ<br>';
      document.getElementById('verificationData').textContent = 'Verification data cleared';
      document.getElementById('verificationSection').style.display = 'none';
      document.getElementById('statsGrid').style.display = 'none';
      
      // Reset counters
      processedCount = 0;
      successfulFinds = 0;
      apiCallTracker = [];
      startTime = null;
    }

    function setButtonLoading(btnId, textId, loading, text) {
      const btn = document.getElementById(btnId);
      const textEl = document.getElementById(textId);
      
      btn.disabled = loading;
      if (loading) {
        textEl.innerHTML = `<span class="loading"></span> ${text}`;
      } else {
        textEl.textContent = text;
      }
    }

    // Auto-focus on API key input
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('apiKeyInput').focus();
      logMessage("üéØ System initialized for 100% dynamic email finding", "success");
      logMessage("üìã Upload your CSV to begin live API processing", "info");
    });
  </script>
</body>
</html>